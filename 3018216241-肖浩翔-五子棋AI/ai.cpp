#include "ai.h"
#include "board.h"
#include <algorithm>
#include <cstring>
#include <deque>
#include <memory>

namespace AI
{

const int MaxDepth = 7;
const int MaxBranch = 12;
const WeightType RowTypeScore[32] = {0,   1,     1,   10,  1,     10,   10,  100,   1,     10,      10,
                                     100, 10,    100, 100, 10000, 1,    5,   10,    30,    10,      100,
                                     100, 10000, 10,  100, 100,   10000, 100, 10000, 10000, 10000000};
const WeightType INF = 1e20;
const uint64_t BigNums[2][BoardSize][BoardSize] = {{{
                                                        15997948142680908598ULL,
                                                        2687409545667818648ULL,
                                                        10714184712589621534ULL,
                                                        13564055009060906827ULL,
                                                        18178250162623513131ULL,
                                                        3705846906189341080ULL,
                                                        3176018488344859346ULL,
                                                        330346402522394254ULL,
                                                        8381212746172679174ULL,
                                                        7578383008623449595ULL,
                                                        11673236833169321426ULL,
                                                        16888543940890971892ULL,
                                                        13567971350621306944ULL,
                                                        2911265543074816746ULL,
                                                        3584345375271885019ULL,
                                                    },
                                                    {
                                                        12764902357093724238ULL,
                                                        4358975424253416190ULL,
                                                        14452201691868141283ULL,
                                                        4930444276332226661ULL,
                                                        16213466837182290405ULL,
                                                        18404251348958432562ULL,
                                                        312163534072227329ULL,
                                                        16492257812047197599ULL,
                                                        12023536952946453784ULL,
                                                        795239067828683996ULL,
                                                        7939933085996196192ULL,
                                                        13033198918072597969ULL,
                                                        9906726508084655888ULL,
                                                        2749363208991721305ULL,
                                                        734690364404567535ULL,
                                                    },
                                                    {
                                                        9797014923214280349ULL,
                                                        7702007990046040921ULL,
                                                        18415576790690124146ULL,
                                                        17843071649904856350ULL,
                                                        10614221428694047656ULL,
                                                        2789184760697941864ULL,
                                                        17589980729351713424ULL,
                                                        12218594103638646975ULL,
                                                        3764564527399063440ULL,
                                                        3060752730269986120ULL,
                                                        11039174057988091675ULL,
                                                        4453093725914030242ULL,
                                                        1428727177763754894ULL,
                                                        9214583130188584589ULL,
                                                        10250002332802572288ULL,
                                                    },
                                                    {
                                                        11848740608708338547ULL,
                                                        16629233932661617243ULL,
                                                        2191819727177078371ULL,
                                                        10295945022599662014ULL,
                                                        15804791609962365715ULL,
                                                        1423539127212277547ULL,
                                                        13060701589367517927ULL,
                                                        12296647765222133127ULL,
                                                        5699128944002484072ULL,
                                                        6252851886946278137ULL,
                                                        10042850559593486777ULL,
                                                        8381946428683046095ULL,
                                                        14733538073170909088ULL,
                                                        3296246168954179916ULL,
                                                        13729461984763379193ULL,
                                                    },
                                                    {
                                                        7501048750080318687ULL,
                                                        10341956867640240258ULL,
                                                        17021465717408337631ULL,
                                                        15947723699706597618ULL,
                                                        5474330086121773335ULL,
                                                        17516629546383506381ULL,
                                                        15185478214282945313ULL,
                                                        8406930624846424ULL,
                                                        14507456323323339120ULL,
                                                        14160769458773725768ULL,
                                                        7689787464085858694ULL,
                                                        10330206445523095699ULL,
                                                        8224044129717435468ULL,
                                                        7858333192327973864ULL,
                                                        4301531919894858647ULL,
                                                    },
                                                    {
                                                        15311796613054486395ULL,
                                                        7367403859932190130ULL,
                                                        7403365384426262504ULL,
                                                        9763961589070821168ULL,
                                                        1102275295800703286ULL,
                                                        3178914480368185461ULL,
                                                        4082058728822618306ULL,
                                                        328618611371086726ULL,
                                                        11011280656367764232ULL,
                                                        7810123719081906788ULL,
                                                        13286978795022145079ULL,
                                                        768502346464283464ULL,
                                                        17136129979253265259ULL,
                                                        12075754037853501384ULL,
                                                        12379050413054701999ULL,
                                                    },
                                                    {
                                                        10876821739625732042ULL,
                                                        13877868492735668653ULL,
                                                        14487072683085770501ULL,
                                                        3476041406474259486ULL,
                                                        11656451791739693317ULL,
                                                        17125060347579751439ULL,
                                                        461532193497962695ULL,
                                                        6971151643016813438ULL,
                                                        12532378192144964296ULL,
                                                        13661902389044998650ULL,
                                                        4811706855838115785ULL,
                                                        1007285721329452751ULL,
                                                        9782058277732748956ULL,
                                                        10215917637376767804ULL,
                                                        8911174522768275153ULL,
                                                    },
                                                    {
                                                        12615636062290311606ULL,
                                                        16570818813155391001ULL,
                                                        6008154985074606780ULL,
                                                        16067536937576573872ULL,
                                                        14268730210880389900ULL,
                                                        8800631957639757024ULL,
                                                        8218919772115533926ULL,
                                                        14442620461061828738ULL,
                                                        11485113463523711687ULL,
                                                        7242505066293670011ULL,
                                                        9876981664672652946ULL,
                                                        4374396140586740047ULL,
                                                        3540637862713539720ULL,
                                                        6429549873259608171ULL,
                                                        14950305645489383713ULL,
                                                    },
                                                    {
                                                        8725573302841004555ULL,
                                                        9233841538406890267ULL,
                                                        13778060650554970763ULL,
                                                        4069885775911803162ULL,
                                                        13489817663179159166ULL,
                                                        16522772172356100892ULL,
                                                        820884466374804827ULL,
                                                        17413474301899294815ULL,
                                                        9710584121653378661ULL,
                                                        11087138504982491819ULL,
                                                        7560670405309134830ULL,
                                                        7678744455330558651ULL,
                                                        1445080276054002894ULL,
                                                        4539327610045749992ULL,
                                                        4976283330662433245ULL,
                                                    },
                                                    {
                                                        12056044921068310114ULL,
                                                        6369042254121405406ULL,
                                                        3526411837413990156ULL,
                                                        8625555069775855542ULL,
                                                        10473870638233284022ULL,
                                                        8924217175890251044ULL,
                                                        5219966232648527755ULL,
                                                        11294716000272218116ULL,
                                                        18272985110935588937ULL,
                                                        1295246104446189792ULL,
                                                        14018763399589286825ULL,
                                                        16322305776583829259ULL,
                                                        12598472303643276552ULL,
                                                        168099788372382965ULL,
                                                        3832342164500005418ULL,
                                                    },
                                                    {
                                                        4430515613897186607ULL,
                                                        11753180038317974003ULL,
                                                        3686458758107533733ULL,
                                                        3111633859726728920ULL,
                                                        16660897712782562817ULL,
                                                        2169693887974564535ULL,
                                                        5578686666558477777ULL,
                                                        5814767062763975358ULL,
                                                        9558539038391864440ULL,
                                                        10055294465922733504ULL,
                                                        5051477494040159229ULL,
                                                        16998834641075576282ULL,
                                                        4500012889412729992ULL,
                                                        6633525207022837128ULL,
                                                        15183774637667845700ULL,
                                                    },
                                                    {
                                                        16615915662986085297ULL,
                                                        16822064027719647693ULL,
                                                        5143062541048692754ULL,
                                                        10387457850115624502ULL,
                                                        15540478614029272663ULL,
                                                        15489306849297532572ULL,
                                                        14025116948357710565ULL,
                                                        8525999939207841638ULL,
                                                        18016873012426239300ULL,
                                                        17085313329499581110ULL,
                                                        17951618588009334379ULL,
                                                        14245801396070566989ULL,
                                                        8442958651044637867ULL,
                                                        2222253312094182325ULL,
                                                        10069023319209756730ULL,
                                                    },
                                                    {
                                                        1563290964975682880ULL,
                                                        8015353197330264984ULL,
                                                        16882682484125020502ULL,
                                                        430267468832886870ULL,
                                                        2571428693220199052ULL,
                                                        16094831827232653830ULL,
                                                        10674783817020277398ULL,
                                                        14530014872272897104ULL,
                                                        9349099427989591647ULL,
                                                        3828152845743927925ULL,
                                                        10996534253289250741ULL,
                                                        16968431733181384559ULL,
                                                        2442192812729481807ULL,
                                                        4895763469536342859ULL,
                                                        13895921667969301916ULL,
                                                    },
                                                    {
                                                        1137017027274200025ULL,
                                                        17783143323152484870ULL,
                                                        2605902416904669083ULL,
                                                        5573381158680702932ULL,
                                                        9119260561673433598ULL,
                                                        1570751514693924640ULL,
                                                        10487487175824051352ULL,
                                                        1628200634610889644ULL,
                                                        11400982763067934041ULL,
                                                        3103692941401188508ULL,
                                                        10877938701408102611ULL,
                                                        5946319950337079864ULL,
                                                        15131121327844405736ULL,
                                                        8053965275973689357ULL,
                                                        2076313102530593366ULL,
                                                    },
                                                    {
                                                        3082562996189076403ULL,
                                                        15218595263820149914ULL,
                                                        11853442624942237451ULL,
                                                        13771479382197431714ULL,
                                                        12804446512851009830ULL,
                                                        17097018181585737224ULL,
                                                        18076941490035953958ULL,
                                                        3717747848731064832ULL,
                                                        15666920423931628720ULL,
                                                        7146375328289723177ULL,
                                                        14709200426339573936ULL,
                                                        10788790329555406579ULL,
                                                        5564738104084310453ULL,
                                                        3030598304235845726ULL,
                                                        2301962510897764961ULL,
                                                    }},
                                                   {{
                                                        5300857990833847597ULL,
                                                        11560362947897572549ULL,
                                                        16093894225736278343ULL,
                                                        10403619774323779024ULL,
                                                        152161751798421732ULL,
                                                        10498967215999282030ULL,
                                                        10930002668752250369ULL,
                                                        1826651001190356113ULL,
                                                        14159258790492674486ULL,
                                                        12514355914979199784ULL,
                                                        13540965403095141752ULL,
                                                        6885562402481733065ULL,
                                                        4545658152587963137ULL,
                                                        17231403718713530188ULL,
                                                        14792582731018806011ULL,
                                                    },
                                                    {
                                                        1800025390334836220ULL,
                                                        2880735998436650526ULL,
                                                        4040369663760322438ULL,
                                                        17794056791461981123ULL,
                                                        7047422445128246526ULL,
                                                        3005486798565237718ULL,
                                                        380799376796077801ULL,
                                                        5796917802647742412ULL,
                                                        10134869535034993775ULL,
                                                        17035150055950933937ULL,
                                                        1055103361260213270ULL,
                                                        1410374665343151562ULL,
                                                        17578829034138593143ULL,
                                                        13471957408807114832ULL,
                                                        7731067804515287289ULL,
                                                    },
                                                    {
                                                        8896314532952485814ULL,
                                                        3839271863677781285ULL,
                                                        14311930382543894528ULL,
                                                        8472186781233619891ULL,
                                                        12869226381979363797ULL,
                                                        15259097780602500112ULL,
                                                        13772227191653002266ULL,
                                                        17527326617870304293ULL,
                                                        13789177663974285801ULL,
                                                        5715722540456045894ULL,
                                                        13521785748747362057ULL,
                                                        4491217228640891687ULL,
                                                        16863997465105800737ULL,
                                                        9627190781580403050ULL,
                                                        11160392651148987341ULL,
                                                    },
                                                    {
                                                        7802592896027441539ULL,
                                                        17817181115558800854ULL,
                                                        1057879086454110330ULL,
                                                        10683962493645818818ULL,
                                                        11088561949041727783ULL,
                                                        9515072116201376966ULL,
                                                        4780240237672068295ULL,
                                                        17633413169702450106ULL,
                                                        12970091275157040689ULL,
                                                        2410639830496782343ULL,
                                                        1521531210033365783ULL,
                                                        2000988593047117347ULL,
                                                        14696043471515187783ULL,
                                                        193653440853780894ULL,
                                                        12097526925750485418ULL,
                                                    },
                                                    {
                                                        11070077288698552610ULL,
                                                        17734839759701263341ULL,
                                                        16354214532727115509ULL,
                                                        7094309060761231089ULL,
                                                        1957035878237463569ULL,
                                                        3664335996931414866ULL,
                                                        9494177183859685412ULL,
                                                        3581164512713468979ULL,
                                                        1976282109412599082ULL,
                                                        13405260143310115513ULL,
                                                        10551923429159574926ULL,
                                                        12642064106330574512ULL,
                                                        9481725073911779242ULL,
                                                        18222367790001088293ULL,
                                                        4775323201151297151ULL,
                                                    },
                                                    {
                                                        14106036439406817461ULL,
                                                        12204486082495462556ULL,
                                                        13383942540222088601ULL,
                                                        15685927066916590601ULL,
                                                        6700421114919584815ULL,
                                                        6933960906090759075ULL,
                                                        6657024709330233736ULL,
                                                        14729301114369883947ULL,
                                                        4939653519926737076ULL,
                                                        6720549407773267737ULL,
                                                        13496659025216687071ULL,
                                                        16314320128659625190ULL,
                                                        12548953515427667238ULL,
                                                        11664133325585296277ULL,
                                                        12633831933939718372ULL,
                                                    },
                                                    {
                                                        4333367156352962966ULL,
                                                        784980890101043429ULL,
                                                        3126381904509741801ULL,
                                                        2868850696533577477ULL,
                                                        3109316359877749924ULL,
                                                        10490149735804341056ULL,
                                                        2069047517023241775ULL,
                                                        17906931631009077016ULL,
                                                        13973599286211854281ULL,
                                                        6493121335704891375ULL,
                                                        14063296100225341403ULL,
                                                        1448717140462667336ULL,
                                                        14314102013460535699ULL,
                                                        16525062908926401680ULL,
                                                        5802343206972705893ULL,
                                                    },
                                                    {
                                                        146446041245636591ULL,
                                                        17384230762531487702ULL,
                                                        16731449818405585088ULL,
                                                        8277734245454694694ULL,
                                                        6918685880238552403ULL,
                                                        5157680183086384669ULL,
                                                        14399042937893078571ULL,
                                                        8771499141855521739ULL,
                                                        7141761094369230744ULL,
                                                        13349127644234892170ULL,
                                                        17454386428264111494ULL,
                                                        1496075960211223796ULL,
                                                        6717871001483062647ULL,
                                                        14543048298149202721ULL,
                                                        4942639746969098196ULL,
                                                    },
                                                    {
                                                        6449283543421047441ULL,
                                                        7977841296788613509ULL,
                                                        11320590500784404621ULL,
                                                        16907987988921818871ULL,
                                                        4008051081145554127ULL,
                                                        4123955168644106318ULL,
                                                        457362106718414334ULL,
                                                        11303968987196852471ULL,
                                                        7288911350135112849ULL,
                                                        4463683031250564185ULL,
                                                        11900202553871904299ULL,
                                                        9544072905941083154ULL,
                                                        7537283184196762275ULL,
                                                        900009258545748558ULL,
                                                        2964211814008748055ULL,
                                                    },
                                                    {
                                                        1332702553074268390ULL,
                                                        12115872080556009353ULL,
                                                        17019922505532071675ULL,
                                                        10546476833711552881ULL,
                                                        3309618126871183069ULL,
                                                        5373372850629691214ULL,
                                                        14532392127111183811ULL,
                                                        13844039377029031827ULL,
                                                        11908704548744733008ULL,
                                                        13987098569543046614ULL,
                                                        1129366162241335926ULL,
                                                        11711273084864795265ULL,
                                                        3065954469998341660ULL,
                                                        15888123641848995340ULL,
                                                        3393616767583788009ULL,
                                                    },
                                                    {
                                                        6823513306029000366ULL,
                                                        7058131024527352540ULL,
                                                        390269491117383122ULL,
                                                        2747939578614811767ULL,
                                                        13957241251088342509ULL,
                                                        15896529619259908020ULL,
                                                        3482815088116966354ULL,
                                                        11695039639998089115ULL,
                                                        11666165387165068466ULL,
                                                        16817347621376978632ULL,
                                                        5168110333970761333ULL,
                                                        8156604636812314109ULL,
                                                        13349409415633887176ULL,
                                                        9957173919277115915ULL,
                                                        4586953922876347982ULL,
                                                    },
                                                    {
                                                        16621166070006839256ULL,
                                                        728986535796767580ULL,
                                                        5100119014289583134ULL,
                                                        1452968819140244334ULL,
                                                        2127770747237296235ULL,
                                                        16222377742450800842ULL,
                                                        13019109581459738148ULL,
                                                        572117768618834899ULL,
                                                        6336449651965442502ULL,
                                                        9656551397438593296ULL,
                                                        7557346636010328683ULL,
                                                        7745702038830677598ULL,
                                                        13830033273283952362ULL,
                                                        4730399106116171796ULL,
                                                        2910507299048683397ULL,
                                                    },
                                                    {
                                                        15660225609021555060ULL,
                                                        1622686724102293688ULL,
                                                        16552602490967213170ULL,
                                                        4701357248004423677ULL,
                                                        14480359571119517694ULL,
                                                        3736916041913121007ULL,
                                                        16131546362915057353ULL,
                                                        1993661294082867758ULL,
                                                        7121966576498392813ULL,
                                                        8395192806321073613ULL,
                                                        10896283521042282916ULL,
                                                        2112076206187213896ULL,
                                                        3637961334863923518ULL,
                                                        8787498385016766789ULL,
                                                        7519627297095262053ULL,
                                                    },
                                                    {
                                                        17863121081131706203ULL,
                                                        15546561379139323843ULL,
                                                        5486046533875268422ULL,
                                                        457099018187917271ULL,
                                                        10179828029230785649ULL,
                                                        9308817294086439572ULL,
                                                        975306776168246187ULL,
                                                        15735116955150686382ULL,
                                                        10324732165419640947ULL,
                                                        13461756604619383015ULL,
                                                        17929917515092883648ULL,
                                                        16871289353240599786ULL,
                                                        573653478193112474ULL,
                                                        6639070256694339473ULL,
                                                        7674181830273104643ULL,
                                                    },
                                                    {
                                                        17699662262889321182ULL,
                                                        6867028150125738778ULL,
                                                        194652781028111579ULL,
                                                        1522808068559593186ULL,
                                                        16097350917625808809ULL,
                                                        12016009759883157999ULL,
                                                        7215721268151646873ULL,
                                                        11391714641378185701ULL,
                                                        2774782363843077457ULL,
                                                        17680028710480318817ULL,
                                                        2928182683460108595ULL,
                                                        2123732314000473628ULL,
                                                        4928420081865865765ULL,
                                                        2620515337189587614ULL,
                                                        5352000909908824952ULL,
                                                    }}};

const int MaxTableSize = 100000000;

TwoWeightedMat WMat;

P solve(const ChessBoard &board)
{
    ChessBoard brd = board;
    uint64_t hashv = boardHasher(brd);
    if (hashv == 0)
    {
        return P(7, 7);
    }
    else
    {
        PieceState clr = board.state() == BoardState::TurnOfBlack ? PieceState::Black : PieceState::White;

        std::memset(&WMat, 0, sizeof(WMat));
        assessBoard(brd, WMat);
        auto &&nextSteps = getNext(brd, WMat);
        WeightType best = -INF;
        WeightType A = -INF, B = INF;
        WeightedPointTable table;
        P res;

        for (const auto &i : nextSteps)
        {
            brd[i.first] = clr;
            best = std::max(best, DFS(brd, hashv ^ BigNums[clr == PieceState::White][i.first.x][i.first.y], table, -B,
                                      -A, 0, PieceState(-clr)));

            brd[i.first] = PieceState::Empty;
            if (best > A)
            {
                A = best;
                res = i.first;
            }
        }
        return res;
    }
}

WeightType DFS(ChessBoard &brd, uint64_t hashv, WeightedPointTable &tab, WeightType A, WeightType B, int depth,
               PieceState clr)
{

    WeightType res = 0;
    auto tabIt = tab.find(hashv);
    if (tabIt == tab.end())
    {
        res = tab.size() < MaxTableSize ? tab.insert(std::make_pair(hashv, assessBoard(brd, WMat))).first->second
                                        : assessBoard(brd, WMat);
    }
    if (depth == MaxDepth)
    {
        return std::max(A, res);
    }
    else
    {
        auto &&nextSteps = getNext(brd, WMat);

        WeightType best = -INF;
        for (const auto &i : nextSteps)
        {
            brd[i.first] = clr;
            best = std::max(best, -DFS(brd, hashv ^ BigNums[clr == PieceState::White][i.first.x][i.first.y], tab, -B,
                                       -A, depth + 1, PieceState(-clr)));
            brd[i.first] = PieceState::Empty;
            if (best >= B)
            {
                break;
            }
            A = std::max(A, best);
            if (best >= RowTypeScore[31])
            {
                break;
            }
        }
        return best * 0.9;
    }
}

std::vector<WeightedPoint> getNext(const ChessBoard &brd, const TwoWeightedMat &dwmat)
{
    std::vector<WeightedPoint> res;
    for (int i = 0; i < BoardSize; ++i)
    {
        for (int j = 0; j < BoardSize; ++j)
        {
            if (brd[i][j] == PieceState::Empty)
            {
                res.push_back(std::make_pair(P(i, j), dwmat[0][i][j] + dwmat[1][i][j]));
            }
        }
    }
    std::sort(res.begin(), res.end(),
              [](const WeightedPoint &_L, const WeightedPoint &_R) { return _L.second > _R.second; });

    if (res.size() > MaxBranch)
    {
        res.resize(MaxBranch);
    }
    return std::move(res);
}

WeightType assessBoard(const ChessBoard &brd, TwoWeightedMat &dwmat)
{
    WeightType res1 = 0, res2 = 0;

    for (int i = 0; i < BoardSize; ++i)
    {
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(0, i), P(1, 0)));
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(i, 0), P(0, 1)));
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(0, i), P(1, 1)));
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(0, i), P(1, -1)));

        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(0, i), P(1, 0)));
        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(i, 0), P(0, 1)));
        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(0, i), P(1, 1)));
        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(0, i), P(1, -1)));
    }
    for (int i = 1; i < BoardSize; ++i)
    {
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(i, 0), P(1, 1)));
        res1 = std::max(res1, assessBoard(brd, dwmat[0], PieceState::Black, P(i, BoardSize - 1), P(1, -1)));

        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(i, 0), P(1, 1)));
        res2 = std::max(res2, assessBoard(brd, dwmat[1], PieceState::White, P(i, BoardSize - 1), P(1, -1)));
    }
    return res1 - res2;
}

WeightType assessBoard(const ChessBoard &brd, WeightedMat &wmat, const PieceState clr, P S, P dir)
{
    std::deque<WeightType> dq;
    int curStat = 0, last = 0;
    P cur = S;
    WeightType sum = 0, res = 0;

    for (int i = 0; i < 5; i++, cur += dir)
    {
        const PieceState c = brd[cur];
        WeightType score;
        --last;
        if (c == -clr)
        {
            last = 5;
            curStat = 0;
        }
        else
        {
            curStat = ((curStat << 1) + (c == clr)) & 31;
        }
        if (last > 0)
        {
            score = 0;
        }
        else
        {
            score = RowTypeScore[curStat];
            if (score < 1000)
            {
                if (last == 0)
                {
                    score *= 0.1;
                }
                if (!ChessBoard::inBoard(cur + dir))
                {
                    return 0;
                }
                else if (brd[cur + dir] == -c)
                {
                    score *= 0.1;
                }
            }
        }
        sum += score;
        dq.push_back(score);
    }
    P pst = S;
    for (; ChessBoard::inBoard(cur); cur += dir)
    {
        const PieceState c = brd[cur];
        WeightType score;
        --last;
        if (c == -clr)
        {
            last = 5;
            curStat = 0;
        }
        else
        {
            curStat = ((curStat << 1) + (c == clr)) & 31;
        }
        if (last > 0)
        {
            score = 0;
        }
        else
        {
            score = RowTypeScore[curStat];
            if (score < 1000)
            {
                if (last == 0)
                {
                    score *= 0.1;
                }
                if (brd.unreachable(cur + dir, clr))
                {
                    score *= 0.1;
                }
            }
        }

        wmat[pst.x][pst.y] += sum;
        res += sum;
        sum -= dq.front();
        dq.pop_front();
        pst += dir;

        sum += score;
        dq.push_back(score);
    }

    for (; ChessBoard::inBoard(pst); pst += dir)
    {
        wmat[pst.x][pst.y] += sum;
        res += sum;
        sum -= dq.front();
        dq.pop_front();
    }
    return res;
}

uint64_t boardHasher(const ChessBoard &brd)
{
    uint64_t res = 0;
    for (int i = 0; i < BoardSize; ++i)
    {
        for (int j = 0; j < BoardSize; ++j)
        {
            if (brd[i][j] == PieceState::Black)
            {
                res ^= BigNums[0][i][j];
            }
            else if (brd[i][j] == PieceState::White)
            {
                res ^= BigNums[1][i][j];
            }
        }
    }
    return res;
}

} // namespace AI